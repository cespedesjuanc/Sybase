--to check the inbound and outbound queues for a database replication
admin who,sqm, CPDB4, svp_cp
--admin who,sqm, CPDB4, svp_cp
--admin who,sqm, CPIQ, svp_cp_iq_conn1

sysadmin hibernate_on, hqvsybrep3
sysadmin sqm_purge_queue, 246, 0
sysadmin hibernate_off, hqvsybrep3

suspend connection to CPDB4.svp_cp

drop subscription CPDB4_svp_cp_dbsub
for database replication definition CPDB2_svp_cp_dbrep
with primary at CPDB2.svp_cp
with replicate at CPDB4.svp_cp
without purge

resume connection to CPDB4.svp_cp

define subscription CPDB4_svp_cp_dbsub
for database replication definition CPDB2_svp_cp_dbrep
with primary at CPDB2.svp_cp
with replicate at CPDB4.svp_cp
subscribe to truncate table
use dump marker

validate subscription CPDB4_svp_cp_dbsub
for database replication definition CPDB2_svp_cp_dbrep
with primary at CPDB2.svp_cp
with replicate at CPDB4.svp_cp

Step 3:
 
chown sybase /opt/sap/db_backups -- run only if necessary (in case you're getting permission denied error when trying to copy the dump file)
--dump database svp_cp to '/home/sybase/db_backups/svp_cp.dmp' compression=100
--scp /home/sybase/db_backups/svp_cp.dmp sybase@CPDB4:~/db_backups/
 
Step 4:
 
--load database svp_cp from '/opt/sap/db_backups/svp_cp.dmp'
--online database svp_cp
 
Step 5 (ON Standby):
 
use svp_cp
go
sp_stop_rep_agent svp_cp
go
sp_config_rep_agent svp_cp, send_warm_standby_xacts,true
go
dbcc settrunc(ltm,ignore)
go
select db_name(dbid),* from master..syslogshold



--***************** THE STEPS BELOW ARE TO DROP THE SUBSCRIPTION MANUALLY WHEN THE DROP SUBSCRIPTION COMMAND DOES NOT WORK **********--

select s.subname, s.subid, s.type, s.dbid, s.pdbid from rs_subscriptions s where subname = "CPDB4_svp_cp_dbsub" --take not of the pdbid

select s.subname, s.subid, s.type, d.dbname, s.dbid, s.pdbid from rs_subscriptions s, rs_databases d where subname = "CPDB4_svp_cp_dbsub" and s.dbid = d.dbid

select * from rs_rules where rs_rules.subid = (select s.subid from rs_subscriptions s where subname = "CPDB4_svp_cp_dbsub")--Clean up rs_rules system table if the subscription has a where clause (if 0 rows returned, then no need to continue!)

select * from rs_subscriptions where pdbid = 231 and dbid = 246 --If the row of the subscription we want to delete is the only row returned, then this means that this is the only/last subscription for this primary database. Therefore, we want to delete the row for this database/subscription from rs_repdbs.

select * from rs_repdbs where dbid = 246

select * from rs_subscriptions where subid=0x0100006580000233

--***************** END OF MANUAL SUBSCRIPTION DROP **********--