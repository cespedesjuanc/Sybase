--============================================================================================================================================================================================================
--Following are the steps to check if a database was added to the replication server. Do this before anything else to confirm that you have to run the rs_init command to add the replication agent
--============================================================================================================================================================================================================
in Primary db (DBARTISAN):
--==============
use lmscan
go
sp_reptostandby lmscan,'all'
go
sp_setrepdbmode lmscan,uds,'off' --<-- Keeping it off
go
sp_config_rep_agent lmscan,disable --this will return an error if replication has never been configured for the database
go
--====
-- In Secondary db
--===
use lmscan
go
sp_reptostandby lmscan,'all'
go
sp_setrepdbmode lmscan,uds,'off' --<-- Keeping it off
go
sp_config_rep_agent lmscan,disable --this will return an error if replication has never been configured for the database
go
--=========================================================================END OF INITIAL CHECK===================================================================================================================================

--============================================================================================================================================================================================================
--Following steps are to start replicating a new database that has never been configured for replication before.
--============================================================================================================================================================================================================
--Configure replication for all databases through rs_init. The rs_init will create the threads for the log reader agent and create the logical connection to the specified database.

cd /opt/sybase/REP-15_5/install/
./rs_init -r /opt/sybase/cron_scripts/replication_setup/CPDB2_lmscan_setupdb.rs
./rs_init -r /opt/sybase/cron_scripts/replication_setup/CPDB1_lmscan_setupdb.rs
./rs_init -r /opt/sybase/cron_scripts/replication_setup/CPDB4_lmscan_setupdb.rs


--=================
-- In PDB
--=================
use lmscan
go
sp_stop_rep_agent lmscan
go
sp_config_rep_agent lmscan, send_warm_standby_xacts,true
go
--sp_config_rep_agent lmscan, 'ltl metadata reduction', 'true'
go
sp_start_rep_agent lmscan
go
--=================
-- In RDB
--=================
use lmscan
go
sp_stop_rep_agent lmscan
go
sp_config_rep_agent lmscan, send_warm_standby_xacts,true
go
--sp_config_rep_agent lmscan, 'ltl metadata reduction', 'true'
go
--sp_start_rep_agent lmscan --> DO NOT RESTART THE REPAGENT
go

--=================
In PRS:
--=================
--If you set dsi_compile_enable off, Replication Server uses continuous log-order, row-by-row replication mode
--Enable dsi_replication_ddl to replicate DDL statements.
--Disable dsi_keep_triggers to prevent Adaptive Server from firing triggers for the replicated transactions, thereby preventing duplicate updates in the standby database
--dist_sqt_max_cache_size defines The maximum Stable Queue Transaction (SQT) cache size for the DIST connection.
--Dynamic SQL allows the Replication Server Data Server Interface (DSI) to prepare dynamic SQL statements at the target user database and to run them repeatedly.

alter connection to CPDB1.lmscan set dsi_compile_enable to 'on'
go
alter connection to CPDB1.lmscan set dsi_replication_ddl to 'on'
go
alter connection to CPDB1.lmscan set dsi_keep_triggers to 'off'
go
alter connection to CPDB1.lmscan set dsi_compile_max_cmds to '100000'
go
alter connection to CPDB1.lmscan set dist_sqt_max_cache_size to '509715200'
go
alter connection to CPDB1.lmscan set dynamic_sql to 'off'
go
alter connection to CPDB1.lmscan set dsi_row_count_validation to 'off'
go
suspend connection to CPDB1.lmscan
go
resume connection to CPDB1.lmscan
go

alter connection to CPDB4.lmscan set dsi_compile_enable to 'on'
go
alter connection to CPDB4.lmscan set dsi_replication_ddl to 'on'
go
alter connection to CPDB4.lmscan set dsi_keep_triggers to 'off'
go
alter connection to CPDB4.lmscan set dsi_compile_max_cmds to '100000'
go
alter connection to CPDB4.lmscan set dist_sqt_max_cache_size to '509715200'
go
alter connection to CPDB4.lmscan set dynamic_sql to 'off'
go
alter connection to CPDB4.lmscan set dsi_row_count_validation to 'off'
go
suspend connection to CPDB4.lmscan
go
resume connection to CPDB4.lmscan
go

--==================

create database replication definition CPDB2_lmscan_dbrep
with primary at CPDB2.lmscan
replicate DDL
replicate system procedures
--replicate SQLDML --<--- Not using this for now

define subscription CPDB2_lmscan_dbsub
for database replication definition CPDB2_lmscan_dbrep
with primary at CPDB2.lmscan
with replicate at CPDB1.lmscan
subscribe to truncate table
use dump marker

validate subscription CPDB2_lmscan_dbsub
for database replication definition CPDB2_lmscan_dbrep
with primary at CPDB2.lmscan
with replicate at CPDB1.lmscan

define subscription CPDB4_lmscan_dbsub
for database replication definition CPDB2_lmscan_dbrep
with primary at CPDB2.lmscan
with replicate at CPDB4.lmscan
subscribe to truncate table
use dump marker

validate subscription CPDB4_lmscan_dbsub
for database replication definition CPDB2_lmscan_dbrep
with primary at CPDB2.lmscan
with replicate at CPDB4.lmscan



--=================
in RDB
--=================
use lmscan
go
dbcc settrunc(ltm,ignore) -- make sure that you disable repagent on the replicate, after the load
go
sp_dropuser N'lmscan_maint'
go
sp_dropalias N'lmscan_maint' --drop alias this is sometimes necessary specially if the database is involved in replication
GO
sp_addalias N'lmscan_maint', N'dbo' --add the database as dbo for appropriate permissions
GO
select db_name(dbid),* from master..syslogshold -- this should return no results for the affected database
go
--================================================================================END OF REPLICATION CONFIGURATION============================================================================================================================


--============================================================================================================================================================================================================
--Following are the steps to RESYNCH a database by dropping and recreating the subscription
--============================================================================================================================================================================================================

-- drop the current subscription (use the following query after connecting to rssd to confirm the existence of a subscription for the database: select top 10 * from  rs_subscriptions where subname like '%lmscan%')
drop subscription CPDB4_lmscan_dbsub
for database replication definition CPDB2_lmscan_dbrep
with primary at CPDB2.lmscan
with replicate at CPDB4.lmscan
without purge

drop subscription CPDB2_lmscan_dbsub
for database replication definition CPDB2_lmscan_dbrep
with primary at CPDB2.lmscan
with replicate at CPDB1.lmscan
without purge

define subscription CPDB4_lmscan_dbsub
for database replication definition CPDB2_lmscan_dbrep
with primary at CPDB2.lmscan
with replicate at CPDB4.lmscan
subscribe to truncate table
use dump marker

validate subscription CPDB4_lmscan_dbsub
for database replication definition CPDB2_lmscan_dbrep
with primary at CPDB2.lmscan
with replicate at CPDB4.lmscan

define subscription CPDB2_lmscan_dbsub
for database replication definition CPDB2_lmscan_dbrep
with primary at CPDB2.lmscan
with replicate at CPDB1.lmscan
subscribe to truncate table
use dump marker

validate subscription CPDB2_lmscan_dbsub
for database replication definition CPDB2_lmscan_dbrep
with primary at CPDB2.lmscan
with replicate at CPDB1.lmscan





--================================================================================END OF REPLICATION RESYNCH CONFIG============================================================================================================================

-- if you need to drop repdef
drop database replication definition CPDB2_lmscan_dbrep
with primary at CPDB1.lmscan